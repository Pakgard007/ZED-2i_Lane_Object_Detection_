import pyzed.sl as sl
import cv2
import numpy as np

# ----------------- 1. ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ZED 2i -----------------
zed = sl.Camera()

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á
init_params = sl.InitParameters()
init_params.camera_resolution = sl.RESOLUTION.HD2K  # ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 2K
init_params.camera_fps = 15  # 2K ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 15 FPS
init_params.depth_mode = sl.DEPTH_MODE.NONE  

# ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
if zed.open(init_params) != sl.ERROR_CODE.SUCCESS:
    print("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ!")
    exit()

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏ö‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û
image = sl.Mat()

# ----------------- 2. ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå (2K) -----------------
K = np.array([[1075.36, 0, 1097.49],  
              [0, 1075.76, 625.303],  
              [0, 0, 1]])

dist_coeffs = np.array([-0.077093, 0.0675618, -0.0285450, 0.00015007, -6.00634e-05])

# ----------------- 3. ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï Rotation ‡πÅ‡∏•‡∏∞ Translation -----------------
R = np.array([[ 9.99999957e-01, -2.92793227e-04,  6.70860728e-07],
            [ 2.92793996e-04,  9.99997332e-01, -2.29123790e-03],
            [ 0.00000000e+00,  2.29123800e-03,  9.99997375e-01]
])

T = np.array([[0], [0], [-7.0]])  # ‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏û‡∏∑‡πâ‡∏ô (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£) ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 7m ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô

n = np.array([[0, 0, 1]]).T  # ‡∏û‡∏∑‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡∏ô Z
d = 7  # ‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏û‡∏∑‡πâ‡∏ô

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Homography Matrix ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
H = K @ (R - (T @ n.T) / d) @ np.linalg.inv(K)

print("Updated Homography Matrix (H):\n", H)

# ----------------- 4. ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà -----------------
src_pts = np.array([
    [750, 900],  # ‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô (2K)
    [1600, 900],  # ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô
    [1050, 400],  # ‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô
    [1200, 400]   # ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô
], dtype=np.float32)

dst_pts = np.array([
    [600, 1400],  # ‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á BEV
    [1400, 1400],  # ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á BEV
    [600, 800],  # ‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á BEV
    [1400, 800]   # ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á BEV
], dtype=np.float32)

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Homography Matrix ‡πÉ‡∏´‡∏°‡πà
H, _ = cv2.findHomography(src_pts, dst_pts, cv2.RANSAC)


# ----------------- 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î -----------------
def draw_points(image, points, color, labels=True):
    """
    ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡∏ô‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏à‡∏∏‡∏î

    Args:
        image: ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î
        points: ‡∏à‡∏∏‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î
        color: ‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î (BGR)
        labels: True ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏à‡∏∏‡∏î
    """
    for i, (x, y) in enumerate(points):
        cv2.circle(image, (int(x), int(y)), 10, color, -1)  # ‡∏ß‡∏≤‡∏î‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î
        if labels:
            cv2.putText(image, str(i+1), (int(x)+10, int(y)-10), cv2.FONT_HERSHEY_SIMPLEX, 0.8, color, 2)


# ----------------- 6. ‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô BEV -----------------
while True:
    if zed.grab() == sl.ERROR_CODE.SUCCESS:
        zed.retrieve_image(image, sl.VIEW.LEFT)
        frame = image.get_data()[:, :, :3]  
        frame = cv2.cvtColor(frame, cv2.COLOR_RGB2BGR)  

        # ‡πÅ‡∏Å‡πâ Distortion
        undistorted_frame = cv2.undistort(frame, K, dist_coeffs)

        # ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î `src_pts` ‡∏ö‡∏ô‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (Front View)
        front_view = undistorted_frame.copy()
        draw_points(front_view, src_pts, (0, 0, 255))  # üî¥ ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÉ‡∏ô Front View

        # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Bird's Eye View
        bev_image = cv2.warpPerspective(undistorted_frame, H, (1800, 900))

        # ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î `dst_pts` ‡∏ö‡∏ô‡∏†‡∏≤‡∏û BEV
        draw_points(bev_image, dst_pts, (255, 0, 0))  # üîµ ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô BEV

        # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        cv2.imshow("Front View - ZED 2i (2K)", front_view)
        cv2.imshow("Bird's Eye View (2K)", bev_image)

        if cv2.waitKey(1) & 0xFF == ord('q'):
            break

# ----------------- 7. ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á -----------------
zed.close()
cv2.destroyAllWindows()
